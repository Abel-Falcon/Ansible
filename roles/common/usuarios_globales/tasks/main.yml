---
# Rol: common/usuarios_globales
# GestiÃ³n global de usuarios - Compatible con Ubuntu, AlmaLinux y Bazzite

- name: "ğŸ” Verificar si el sistema usa rpm-ostree (Bazzite)"
  stat:
    path: /usr/bin/rpm-ostree
  register: is_ostree_system

- name: "ğŸ‘¥ Crear grupos del sistema si no existen"
  group:
    name: "{{ item }}"
    state: present
  loop:
    - wheel
    - audio
    - video
    - docker
    - students
    - teachers
  ignore_errors: true

# En Ubuntu, el grupo sudo es el equivalente a wheel
- name: "ğŸ› ï¸ Asegurar grupo 'sudo' en sistemas Debian/Ubuntu"
  group:
    name: sudo
    state: present
  when: ansible_os_family == "Debian"

- name: "ğŸ‘¤ Crear usuarios del Proyecto SO"
  user:
    name: "{{ item.nombre }}"
    comment: "{{ item.descripcion | default('Usuario del Proyecto SO') }}"
    groups: "{{ item.grupos | join(',') }}"
    shell: "{{ item.shell | default('/bin/bash') }}"
    create_home: "{{ item.crear_home | default(true) }}"
    password: "{{ item.password | default('$6$rounds=656000$salt$hash') }}"
    state: present
  loop: "{{ usuarios_proyecto | default([]) }}"
  no_log: true

- name: "ğŸ“ Configurar directorios estÃ¡ndar en /home"
  file:
    path: "/home/{{ item.0.nombre }}/{{ item.1 }}"
    state: directory
    owner: "{{ item.0.nombre }}"
    group: "{{ item.0.nombre }}"
    mode: "0755"
  loop: "{{ usuarios_proyecto | default([]) | product(directorios_home) | list }}"
  vars:
    directorios_home:
      - Desktop
      - Documents
      - Downloads
      - Pictures
      - Videos
      - Projects
      - Scripts

- name: "âš™ï¸ Configurar sudoers sin contraseÃ±a (wheel o sudo)"
  lineinfile:
    path: /etc/sudoers
    regexp: "^%{{ 'wheel' if ansible_os_family != 'Debian' else 'sudo' }}"
    line: "%{{ 'wheel' if ansible_os_family != 'Debian' else 'sudo' }} ALL=(ALL) NOPASSWD: ALL"
    validate: "visudo -cf %s"
  when: configurar_sudo | default(true)

- name: "ğŸ“œ Crear archivo de perfil global del proyecto"
  template:
    src: profile_proyecto.sh.j2
    dest: "/etc/profile.d/proyecto-so.sh"
    mode: "0644"

- name: "ğŸ’» Configurar bashrc personalizado para cada usuario"
  template:
    src: bashrc_global.j2
    dest: "/home/{{ item.nombre }}/.bashrc"
    owner: "{{ item.nombre }}"
    group: "{{ item.nombre }}"
    mode: "0644"
  loop: "{{ usuarios_proyecto | default([]) }}"
